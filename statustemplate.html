<html>

<head>


  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">

  <script src="https://unpkg.com/cytoscape/dist/cytoscape.umd.js"></script>

  <!-- for testing with local version of cytoscape.js -->
  <!--    <script src="../cytoscape.js/build/cytoscape.js"></script> -->

  <script src="https://unpkg.com/dagre@0.7.4/dist/dagre.js"></script>
  <script src="https://cytoscape.org/cytoscape.js-dagre/cytoscape-dagre.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <!-- Material Design Lite -->
  <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <!-- Material Design icon font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
    #cy {
      width: inherit;
      height: inherit;
      position: inherit;
      left: 1%;
      background: #ffffff;
      top: 1%;
      z-index: 999;
      border-width: 10px;

    }

    body {
      padding: 20px;
      background: #fafafa;
      position: relative;
    }

    .demo-card-wide.mdl-card {
      width: 512px;
    }

    .demo-card-wide>.mdl-card__title {
      color: rgb(255, 255, 255);
      height: 176px;
      /* background: url('https://34c84tlmchn2t7lm33f7h3ja-wpengine.netdna-ssl.com/wp-content/uploads/sites/11/2018/05/AHS-logo.jpg') center / cover; */
      background: url('https://getmdl.io/assets/demos/welcome_card.jpg') center / cover;
    }

    .demo-statuscard {
      color: rgb(255, 255, 255);
      background: rgb(255, 255, 255);
      height: 100px;
      width: 512px;
      /* background: url('https://34c84tlmchn2t7lm33f7h3ja-wpengine.netdna-ssl.com/wp-content/uploads/sites/11/2018/05/AHS-logo.jpg') center / cover; */
    }

    .demo-card-wide>.mdl-card__menu {
      color: #fff;
    }
  </style>

</head>

<div id="prepcard" class="demo-card-wide mdl-card mdl-shadow--2dp">
  <div class="mdl-card__title">
    <h2 class="mdl-card__title-text">Precommit</h2>
  </div>
  <div class="mdl-card__supporting-text">
    This screen starts the CKM upload process for <B>%%TICKET%%</B>
    <br>
    <br>
    The entire process can take a few minutes and has two stages:
    <ol>
      <li><b>Precommit:</b> Create a Report for the ticket, showing what will be updated to CKM</li>
      <li><b>Commit</b>: Send changes to CKM in the correct order and show a report confirming the changes.</li>
    </ol>

    As the process is working, a regularly updated status message will be displayed. Additionally a view
    of the template relations is shown below the stage report.
    <br>
    <br><b></b><em>This is preview of the commit workflow, which is under development and not yet tested. There are
      still some bugs to be worked out with the commit order, as well as others.</em></div></b>


  <div id="action-precommit" class="mdl-card__actions mdl-card--border">
    <a id="precommit" class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
      Get Started
    </a>
  </div>
  <div class="mdl-card__menu">
    <button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">
      <i class="material-icons">share</i>
    </button>
  </div>
</div>


<div id="commitcard" class="demo-card-wide mdl-card mdl-shadow--2dp" style="display:none">
  <!-- initally hidden -->
  <div class="mdl-card__title">
    <h2 class="mdl-card__title-text">Commit?</h2>
  </div>
  <div class="mdl-card__supporting-text">
    The preparation process is complete, check the intended actions below and hit commit if you are ready to go!
  </div>
  <div id="action-commit" class="mdl-card__actions mdl-card--border">
    <a id="commit" class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
      Commit
    </a>
  </div>
  <div class="mdl-card__menu">
    <button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">
      <i class="material-icons">share</i>
    </button>
  </div>
</div>


<div id="statuscard" class="demo-statuscard  mdl-shadow--2dp" style="display:none">
  <!-- initally hidden -->
  <div id="statusdata" class="mdl-card__supporting-text">

  </div>
</div>
<BR>

<div id="table-results"></div>
<br>
<div id="graphcard" class="demo-statuscard  mdl-shadow--2dp" style="height:800px; width:800px; display:none" style="text-align:center">
  <h3 style="z-index: 999">ticket asset relationship map</h3>
  <div id="cy" style="display:inline-block"> </div>
</div>

<BR>
<!-- Stop Button -->
<!-- <a href="#" onclick="window.clearInterval(int);return false;">Stop</a> -->
<!-- <pre id="statusdata"></pre> -->
<script type="text/javascript">
  var intTimer

  function start_precommit() {
    $.getJSON("/precommit,%%SESSIONID%%", function () {
      document.getElementById("action-precommit").style.display = "none"
      document.getElementById("statuscard").style.display = "block"
      intTimer = self.setInterval(getStatus, 1000);
    })
  }


  function start_commit() {
    document.getElementById("statusdata").innerHTML = "" + new Date().toLocaleString() +
      " <br>Starting commit!";

    $.getJSON("/commit,%%SESSIONID%%", function () {
      document.getElementById("action-commit").style.display = "none"
      document.getElementById("statuscard").style.display = "block"
      intTimer = self.setInterval(getStatus, 1000);
    })
  }

  function getStatus() {

    $.getJSON("/status,%%SESSIONID%%", function (status) {

      var objStatus = JSON.parse(JSON.stringify(status))

      if (objStatus.IsError) {
        document.getElementById("statusdata").innerHTML = "" + new Date().toLocaleString() +
          " <br><b>ERROR!</b>";

        window.clearInterval(intTimer);
        return false;
      }

      if (objStatus.ProcessingStage == 2) {
        //        alert("prep is finished...")
        //if( objStatus.IsFinishedCommit) { alert ("hmmm....")}

        document.getElementById("prepcard").style.display = "none"
        document.getElementById("commitcard").style.display = "inline-block"

        window.clearInterval(intTimer);
        $.getJSON("/report,%%SESSIONID%%", function (report) {
          document.getElementById("statusdata").innerHTML = "" + new Date().toLocaleString() +
            " <br>Finished Preparation!";
          tableCreate(report, true)

          $.getJSON("/nodes,%%SESSIONID%%", function (nodes) {
            graphCreate(nodes)
          })

          return false

          //var data = $(result).serializeArray()
        });
      }

      if (objStatus.ProcessingStage == 4) {
        //alert("commit finished!")
        window.clearInterval(intTimer);
        $.getJSON("/report,%%SESSIONID%%", function (report) {
          document.getElementById("statusdata").innerHTML = "" + new Date().toLocaleString() +
            " <br>Commit to CKM completed!";
          tableCreate(report, false)

          $.getJSON("/nodes,%%SESSIONID%%", function (nodes) {
            graphCreate(nodes)
          })
        })
        return false;
      }




      document.getElementById("statusdata").innerHTML = "" + new Date().toLocaleString() + " <br>" +
        objStatus.Message +
        " ";
    });
  }

  function graphCreate(theNodesAndEdges) {

    if (theNodesAndEdges == "") {
      return
    }
    document.getElementById("graphcard").style.display = "block"
    var objreport = JSON.parse(JSON.stringify(theNodesAndEdges))
    //alert("parsed nodes")
    var arrayLength = objreport.length;

    if (arrayLength == 2) {

      var nodes = objreport[0]
      var edges = objreport[1]

      displayGraph(nodes, edges);
    }
  }

  function tableCreate(theReport, dryrun) {
    var title
    if (theReport == "") {
      return
    }
    //alert("tableCreate")
    var objreport = JSON.parse(JSON.stringify(theReport))
    var body = document.body
    tbl = document.createElement('table');
    tbl.className = 'mdl-data-table mdl-js-data-table mdl-data-table mdl-shadow--2dp'
    tbl.style.width = '100px';

    var header = tbl.createTHead()
    header.className = 'mdl-data-table__cell--non-numeric'

    //header.insertCell().appendChild(document.createTextNode("Name"))

    var hr = header.insertRow();
    hr.className = 'mdl-data-table__cell--non-numeric'

    hr.insertCell().appendChild(document.createTextNode("Name"))
    hr.insertCell().appendChild(document.createTextNode("Location"))
    hr.insertCell().appendChild(document.createTextNode("Local State"))
    if (dryrun) {
      title = document.createTextNode("Planned Changes");
      hr.insertCell().appendChild(document.createTextNode("Planned Action"))
    } else {
      title = document.createTextNode("Change Report");
      hr.insertCell().appendChild(document.createTextNode("Action Performed"))
    }

    hr.insertCell().appendChild(document.createTextNode("CKM Location"))
    hr.insertCell().appendChild(document.createTextNode("Embedded Within"))
    hr.insertCell().appendChild(document.createTextNode("Commit Order"))

    var arrayLength = objreport.length;
    var td;



    for (var i = 0; i < arrayLength; i++) {

      var tr = tbl.insertRow();

      td = tr.insertCell();
      td.appendChild(document.createTextNode(objreport[i].NodeName));


      td = tr.insertCell();
      td.appendChild(document.createTextNode(objreport[i].NodeLocation));

      td = tr.insertCell();
      switch (objreport[i].NodeChanged) {
        case -1:
          td.appendChild(document.createTextNode("Unknown"));
          break;
        case 0:
          td.appendChild(document.createTextNode("Unedited"));
          break;
        case 1:
          td.appendChild(document.createTextNode("Edited"));
          break;
        case 2:
          td.appendChild(document.createTextNode("Created"));
          break;
        default:
          td.appendChild(document.createTextNode("Unknown"));
          break;
      }


      td = tr.insertCell();
      if (!dryrun) {
        switch (objreport[i].NodeIsCommitted) {
          case -1:
            td.appendChild(document.createTextNode("None"));
            break;
          case 0:
            td.appendChild(document.createTextNode("Failed"));
            break;
          case 1:
            if ((objreport[i].NodeChildChanged == 1) && (objreport[i].NodeChanged < 1)) {
              td.appendChild(document.createTextNode("Version Bump in CKM"));
            } else {
              td.appendChild(document.createTextNode("Committed to CKM"));
            }
            break;
          default:
            td.appendChild(document.createTextNode("Unknown"));
            break;
        }
      } else {
        switch (objreport[i].NodeCommitIntended) {
          case -1:
            td.appendChild(document.createTextNode("None"));
            break;
          case 0:
            td.appendChild(document.createTextNode("Failed"));
            break;
          case 1:
            if ((objreport[i].NodeChildChanged == 1) && (objreport[i].NodeChanged < 1)) {
              td.appendChild(document.createTextNode("Version Bump in CKM"));
            } else {
              td.appendChild(document.createTextNode("Commit to CKM"));
            }
            break;
          default:
            td.appendChild(document.createTextNode("Unknown"));
            break;
        }
      }
      td = tr.insertCell();

      if ((objreport[i].NodeChanged == 2) && (dryrun)) { // asset isn't in ckm yet, so no link
        td.appendChild(document.createTextNode("-"));

      } else {

        var link = document.createElement("a");
        link.setAttribute('target', '_blank');
        link.setAttribute("href", "https://ahsckm.ca/ckm/#showTemplate_" + objreport[i].NodeCID); // 1175.132.9052)
        var linkText = document.createTextNode("Open in CKM");
        link.appendChild(linkText);

        // Add the link to the previously created TableCell.
        td.appendChild(link);
      }

      var relations = objreport[i].NodeParentList
      td = tr.insertCell();

      if (relations != null) {
        var relationsLength = relations.length;

        for (var k = 0; k < relationsLength; k++) {
          if (k == relationsLength - 1) {
            td.appendChild(document.createTextNode(relations[k]))
          } else {
            td.appendChild(document.createTextNode(relations[k] + ", "))
          }

        }


      }

      td = tr.insertCell();
      if (objreport[i].NodeCommitOrder < 0) {
        td.appendChild(document.createTextNode("-"));
      } else {
        td.appendChild(document.createTextNode(objreport[i].NodeCommitOrder));
      }


    }
    var tablelocation = document.getElementById("table-results")
    while (tablelocation.firstChild) {
      tablelocation.removeChild(tablelocation.firstChild);
    }
    tablelocation.appendChild(title)
    tablelocation.appendChild(tbl);
    //body.appendChild(tbl);
  }



  function displayGraph(nodes, edges) {

    //alert(JSON.parse(nodes))
    var elements = {
      nodes,
      edges
    }

    var cy = window.cy = cytoscape({
      container: document.getElementById('cy'),

      boxSelectionEnabled: false,
      autounselectify: true,

      layout: {
        name: 'dagre',
        rankDir: 'BT',
        labelpos: 'R',

      },

      style: [{
          selector: 'node',
          style: {
            'height': 20,
            'width': 20,
            'background-fit': 'cover',
            'border-color': 'data(bg)',
            'border-width': 20,
            'border-opacity': 0.5,

            'background-color': '#11479e',
            //'background-color': '#ff0000',
/*             'text-valign': 'center',
            'text-halign': 'right',
 */            'border-color': 'data(bg)',
            'label': 'data(id)'
          }
        },

        {
          selector: 'edge',
          style: {


//            'line-color': '#9dbaea',
//            'target-arrow-color': '#9dbaea',
            'curve-style': 'bezier',
                        'width': 8,
                        'target-arrow-shape': 'triangle',
                        'border-width': 15,
                        'line-color': '#ffaaaa',
                        'target-arrow-color': '#ffaaaa'            
          }
        }
      ],

      elements: {
        nodes,
        edges

      }

    });

  };

  document.getElementById("precommit").onclick = start_precommit;
  document.getElementById("commit").onclick =
    start_commit;
</script>


<!-- <div id="cy"></div> -->

</html>